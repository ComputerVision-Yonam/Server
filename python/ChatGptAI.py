# ChatGptAI.py
import os
import pandas as pd
from openai import OpenAI
from dotenv import load_dotenv
from tabulate import tabulate
import re
import csv

# 환경변수 불러오기
load_dotenv(dotenv_path=os.path.join(os.path.dirname(__file__), "key.env"))
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
CSV_PATH = os.path.join(os.path.dirname(__file__), "lectures.csv")


# building_aliases.py 또는 ChatGptAI.py 상단에 추가
building_aliases = {
    "산학": "industryHall",
    "산학협동관": "industryHall",
    "산학동": "industryHall",
    "미래관": "Future Hall",
    "미래": "Future Hall",
    "library": "library",
    "도서관": "library"
}


def infer_building_key_from_question(question: str) -> str:
    question = question.lower()  # 소문자 처리
    for alias, building_key in building_aliases.items():
        if alias in question:
            return building_key
    return None


def extract_lecture_text(building: str, max_rows: int = 10) -> str:
    try:
        df = pd.read_csv(CSV_PATH)
        filtered = df[df["강의실"].astype(str).str.contains(building, na=False)]

        if filtered.empty:
            return None

        selected = filtered[['교과목명', '교수', '강의시간표', '강의실']].head(max_rows)
        return tabulate(selected, headers='keys', tablefmt='pipe', showindex=False)

    except Exception as e:
        return f"[CSV 처리 오류] {str(e)}"


def get_general_response(question):
    system_prompt = "너는 연암공과대학교 챗봇이야. 사용자의 질문에 친절하고 존댓말로 답해줘."

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": question}
    ]

    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"GPT 오류: {str(e)}"


def get_lecture_answer_with_gpt(building: str, question: str) -> str:
    """
    사용자의 질문을 바탕으로, building 키에 해당하는 강의 목록을 필터링하고
    이를 기반으로 GPT가 자연스럽게 답변하도록 생성한다.
    """
    try:
        df = pd.read_csv(CSV_PATH)

        # building 키워드가 강의실 열에 포함된 행 추출 (정규 표현식으로 대괄호 안의 내용도 찾도록 개선)
        # re.escape를 사용하여 building 문자열에 특수 문자가 있어도 안전하게 검색
        # 대소문자 구분 없이 찾으려면 flags=re.IGNORECASE 추가 가능
        pattern = f'.*{re.escape(building)}.*'
        filtered = df[df["강의실"].astype(str).str.contains(pattern, na=False, regex=True)]

        if filtered.empty:
            lecture_summary = "해당 건물에서 개설된 강의 정보를 찾을 수 없습니다."
        else:
            # GPT에게 전달할 간략한 요약용 테이블 생성
            # 상위 10개만 선택
            selected = filtered[['교과목명', '교수', '강의시간표', '강의실']].head(10)
            # 만약 강의실 정보가 너무 길다면, 잘라내거나 다른 방식으로 요약하는 로직 추가 가능
            lecture_summary = tabulate(selected, headers='keys', tablefmt='pipe', showindex=False)

        # GPT 프롬프트 구성 (이전과 동일)
        system_prompt = f"""너는 연암공과대학교의 강의 정보를 알려주는 챗봇이야.
                            아래는 '{building}'에서 열리는 강의 목록이야

                            너는 연암공과대학교의 수업 정보와 건물 정보만을 안내하는 챗봇이야.
                            너는 아래 데이터에서 제공된 내용만 기준으로 답변해야 해. 모르면 모른다고 말해야 해.

                            절대로 추측하거나, 상상하거나, 네가 아는 다른 정보로 답하면 안 돼.
                            반드시 "제공된 정보"를 기반으로만 존댓말로 응답해야 해.
                            :

                            학과,전공,학년,이수구분,코드,교과목명,분반,학점,교수,강의시간표,강의실,수강정원,강의유형구분,성적입력구분
전기전자공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,A,1,최여환,수[ 3],첨단항공강의실1[연암미래관1층106호],40,이론,PNP
전기전자공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,C,1,최여환,화[ 2],첨단항공강의실1[연암미래관1층106호],40,이론,PNP
전기전자공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,D,1,최여환,수[ 2],첨단항공강의실1[연암미래관1층106호],40,이론,PNP
전기전자공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,E,1,최여환,화[ 3],첨단항공강의실1[연암미래관1층106호],40,이론,PNP
전기전자공학과,계열(학과)공통,1학년,교양선택,120155,기계공학개론,A,2,최우영,"화[ 3, 4]",다목적강의실[연암미래관1층101호],40,이론,ABCDF
전기전자공학과,계열(학과)공통,1학년,교양선택,120155,기계공학개론,C,2,최우영,"월[ 1, 2]",다목적강의실[연암미래관1층101호],40,이론,ABCDF
전기전자공학과,계열(학과)공통,1학년,교양선택,K0125293,창의융합적문제해결,C,2,이석운,"금[ 8, 9]",다목적강의실[연암미래관1층101호],40,이론,ABCDF
전기전자공학과,계열(학과)공통,1학년,교양선택,K0125293,창의융합적문제해결,E,2,이석운,"목[ 7, 8]",다목적강의실[연암미래관1층101호],40,이론,ABCDF
기계공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,A,1,감병곤,금[ 2],첨단항공강의실2[연암미래관1층107호],0,이론,PNP
기계공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,B,1,감병곤,금[ 7],첨단항공강의실2[연암미래관1층107호],0,이론,PNP
기계공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,C,1,감병곤,금[ 8],첨단항공강의실2[연암미래관1층107호],0,이론,PNP
기계공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,D,1,감병곤,금[ 3],첨단항공강의실2[연암미래관1층107호],0,이론,PNP
기계공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,E,1,감병곤,금[ 5],첨단항공강의실2[연암미래관1층107호],0,이론,PNP
기계공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,F,1,감병곤,금[ 6],첨단항공강의실2[연암미래관1층107호],0,이론,PNP
기계공학과,계열(학과)공통,1학년,교양선택,K0124722,Python,A,3,윤종찬,"화[ 1, 2, 3]",(산협)프로젝트실5[산학협동관지상3층I302호],,이론실습,ABCDF
기계공학과,계열(학과)공통,1학년,교양선택,K0124722,Python,C,3,우상범,"수[ 5, 6, 7]",(산협)프로젝트실5[산학협동관지상3층I302호],,이론실습,ABCDF
기계공학과,계열(학과)공통,1학년,교양선택,K0124722,Python,D,3,김동근,"월[ 5, 6, 7]",(산협)프로젝트실5[산학협동관지상3층I302호],,이론실습,ABCDF
기계공학과,계열(학과)공통,2학년,교양선택,K0125216,AI활용,C,3,이쌍수,"월[ 8, 9]/목[ 1]","(외부)원격강의4[특별강의동1층S194호],(산협)프로젝트실5[산학협동관지상3층I302호]",0,이론실습,ABCDF
기계공학과,계열(학과)공통,2학년,교양선택,K0125216,AI활용,D,3,이쌍수,"월[ 8, 9]/화[ 9]","(외부)원격강의5[특별강의동1층S195호],(산협)프로젝트실5[산학협동관지상3층I302호]",0,이론실습,ABCDF
기계공학과,계열(학과)공통,2학년,교양선택,K0125216,AI활용,E,3,이쌍수,"월[ 8, 9]/수[ 1]","(외부)원격강의6[특별강의동1층S196호],(산협)프로젝트실5[산학협동관지상3층I302호]",0,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,교양선택,K0125146,AI개론,A,1,황광복,수[ 3],SW실습2실[산학협동관지상2층I204호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,교양선택,K0125146,AI개론,B,1,황광복,수[ 7],SW실습2실[산학협동관지상2층I204호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,교양선택,K0125146,AI개론,C,1,황광복,수[ 6],SW실습2실[산학협동관지상2층I204호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,교양선택,K0125293,창의융합적문제해결,A,2,김정근,"월[ 6, 7]",다목적강의실[연암미래관1층101호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,교양선택,K0125293,창의융합적문제해결,C,2,김정근,"월[ 3, 4]",다목적강의실[연암미래관1층101호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125132,HTML5/CSS,A,4,이해동,"금[ 6, 7, 8, 9]",SW합동강의실[산학협동관2층I208호],,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125132,HTML5/CSS,C,4,이해동,"금[ 1, 2, 3, 4]",SW합동강의실[산학협동관2층I208호],,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125425,컴퓨터일반,A,4,최재영,"금[ 1, 2, 3, 4]",SW실습3실[산학협동관4층I410호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125425,컴퓨터일반,B,4,최재영,"수[ 1, 2, 3, 4]",SW실습3실[산학협동관4층I410호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125425,컴퓨터일반,C,4,최재영,"화[ 1, 2, 3, 4]",SW실습3실[산학협동관4층I410호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125573,통계학실습,A,3,노근배,화[ 6]/수[ 2]/목[ 1],SW개발2실[산학협동관3층I309호],,실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125573,통계학실습,B,3,노근배,화[ 7]/수[ 6]/목[ 2],SW개발2실[산학협동관3층I309호],,실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,1학년,전공선택,K0125573,통계학실습,C,3,노근배,화[ 8]/수[ 3]/목[ 3],SW개발2실[산학협동관3층I309호],,실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,교양선택,K0125566,바른인성과리더십,A,1,박명진,목[ 3],첨단항공강의실1[연암미래관1층106호],,이론,PNP
스마트소프트웨어학과,계열(학과)공통,2학년,교양선택,K0125566,바른인성과리더십,B,1,박명진,목[ 2],첨단항공강의실1[연암미래관1층106호],,이론,PNP
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,110922,C++프로그래밍,A,4,황광복,"화[ 6, 7, 8, 9]",SW합동강의실[산학협동관2층I208호],,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,110922,C++프로그래밍,B,4,황광복,"화[ 1, 2, 3, 4]",SW합동강의실[산학협동관2층I208호],,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125427,IoT실습,A,4,변유찬,"월[ 6, 7, 8, 9]",SW실습1실[산학협동관지상2층I207호],0,실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125427,IoT실습,B,4,변유찬,"수[ 1, 2, 3, 4]",SW실습1실[산학협동관지상2층I207호],0,실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125426,JAVA기초,A,2,김기욱,"화[ 1, 2]",SW실습1실[산학협동관지상2층I207호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125426,JAVA기초,B,2,김기욱,"금[ 6, 7]",SW실습1실[산학협동관지상2층I207호],,이론,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125574,JAVA프로그래밍기초,A,2,김기욱,"화[ 3, 4]",SW실습1실[산학협동관지상2층I207호],,실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125574,JAVA프로그래밍기초,B,2,김기욱,"금[ 8, 9]",SW실습1실[산학협동관지상2층I207호],,실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0124242,데이터베이스,A,4,김범준,"수[ 2, 3]/금[ 6, 7]",SW실습5실[산학협동관4층I403호],,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0124242,데이터베이스,B,4,김범준,"수[ 6, 7]/금[ 2, 3]",SW실습5실[산학협동관4층I403호],,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125288,데이터사이언스,A,3,하병국,"월[ 1, 2, 3]",SW실습3실[산학협동관4층I410호],,이론실습,ABCDF
스마트소프트웨어학과,계열(학과)공통,2학년,전공선택,K0125288,데이터사이언스,B,3,하병국,"월[ 6, 7, 8]",SW실습3실[산학협동관4층I410호],,이론실습,ABCDF
스마트소프트웨어학과,SW전공,3학년,전공선택,K0125216,AI활용,A,4,이승익,"목[ 1, 2, 3, 4]",SW실습1실[산학협동관지상2층I207호],,이론실습,ABCDF
스마트소프트웨어학과,SW전공,3학년,전공선택,K0125575,소프트웨어공학실습,A,3,백용진,"수[ 1, 2, 3, 4]",SW합동강의실[산학협동관2층I208호],0,실습,ABCDF
스마트소프트웨어학과,SW전공,3학년,전공선택,K0125576,알고리즘활용,A,4,백용진,"목[ 6, 7, 8, 9]",SW실습1실[산학협동관지상2층I207호],,이론실습,ABCDF
스마트소프트웨어학과,SW전공,3학년,전공선택,110224,운영체제,A,3,이덕기,"월[ 1, 2, 3, 4]",SW실습5실[산학협동관4층I403호],0,이론실습,ABCDF
스마트소프트웨어학과,SAP전공,3학년,교양선택,K0125564,비판적사고와논리적글쓰기,A,2,이석운,"금[ 3, 4]",다목적강의실[연암미래관1층101호],,이론,ABCDF
스마트소프트웨어학과,SAP전공,3학년,전공선택,K0125479,ABAP프로그래밍,A,4,김범준,"화[ 1, 2, 3, 4]",SW실습5실[산학협동관4층I403호],,이론실습,ABCDF
스마트소프트웨어학과,SAP전공,3학년,전공선택,K0125216,AI활용,A,4,이승익,"월[ 1, 2, 3, 4]",SW실습1실[산학협동관지상2층I207호],,이론실습,ABCDF
스마트소프트웨어학과,SAP전공,3학년,전공선택,K0125478,SAP개론,A,4,이덕기,"목[ 1, 2, 3, 4]",SW실습4실[산학협동관4층I404호],0,이론실습,ABCDF
스마트소프트웨어학과,SAP전공,3학년,전공선택,110224,운영체제,A,3,이덕기,"화[ 6, 7, 8, 9]",SW실습5실[산학협동관4층I403호],0,이론실습,ABCDF
스마트기계공학과,기계공학전공,1학년,교양선택,K0125293,창의융합적문제해결,A,2,김정근,"월[ 8, 9]",다목적강의실[연암미래관1층101호],,이론실습,ABCDF
스마트기계공학과,기계공학전공,2학년,전공선택,K0125422,3D CAD UG응용,A,2,이남석,"목[ 5, 6, 7]",(산협)수치해석실습실[산학협동관3층I301호],0,이론실습,ABCDF
스마트기계공학과,기계공학전공,2학년,전공선택,K0125216,AI활용,A,3,이쌍수,"월[ 8, 9]/화[ 8]","플립드러닝A[특별강의동1층S101-1호],(산협)프로젝트실5[산학협동관지상3층I302호]",0,이론실습,ABCDF
스마트기계공학과,기계공학전공,2학년,전공선택,K0124440,동역학,A,3,신현장,"화[ 5, 6, 7]",(산협)수치해석실습실[산학협동관3층I301호],,이론,ABCDF
스마트기계공학과,기계공학전공,3학년,교양선택,K0125564,비판적사고와논리적글쓰기,A,2,강민정,"목[ 5, 6]",첨단항공강의실2[연암미래관1층107호],,이론실습,ABCDF
스마트기계공학과,기계공학전공,3학년,전공선택,K0125567,AI캡스톤디자인,A,3,신현장,"수[ 4, 5, 6]/목[ 1]",(산협)수치해석실습실[산학협동관3층I301호],,실습,ABCDF
스마트기계공학과,기계공학전공,3학년,전공선택,K0125424,수학실습및응용,A,3,신현장,"수[ 1, 2, 3]",(산협)수치해석실습실[산학협동관3층I301호],,이론실습,ABCDF
스마트기계공학과,기계공학전공,3학년,전공선택,K0125128,유한요소법개론,A,2,신현장,"월[ 6, 7]",(산협)수치해석실습실[산학협동관3층I301호],,실습,ABCDF
스마트기계공학과,기계공학전공,3학년,전공선택,K0125129,유한요소법실습,A,2,신현장,"월[ 8, 9]",(산협)수치해석실습실[산학협동관3층I301호],,실습,ABCDF
스마트전기전자공학과,계열(학과)공통,1학년,교양선택,K0125565,MZ세대를위한직업윤리,B,1,최신우,월[ 6],첨단항공강의실1[연암미래관1층106호],40,이론,PNP
스마트전기전자공학과,계열(학과)공통,1학년,교양선택,K0125566,바른인성과리더십,A,1,박명진,목[ 5],첨단항공강의실1[연암미래관1층106호],40,이론,PNP
스마트전기전자공학과,계열(학과)공통,1학년,교양선택,K0125566,바른인성과리더십,B,1,박명진,목[ 6],첨단항공강의실1[연암미래관1층106호],40,이론,PNP
스마트전기전자공학과,계열(학과)공통,1학년,교양선택,K0125293,창의융합적문제해결,A,2,이석운,"금[ 6, 7]",다목적강의실[연암미래관1층101호],40,이론,ABCDF
스마트전기전자공학과,계열(학과)공통,1학년,교양선택,K0125293,창의융합적문제해결,B,2,이석운,"금[ 1, 2]",다목적강의실[연암미래관1층101호],40,이론,ABCDF
스마트전기전자공학과,계열(학과)공통,2학년,교양선택,120155,기계공학개론,A,2,최우영,"화[ 1, 2]",다목적강의실[연암미래관1층101호],40,이론,ABCDF
스마트소프트웨어학과(심화),SW전공,1학년,전공선택,K0125218,컴퓨터비전,A,4,이승익,"수[ 2, 3]/금[ 2, 3]",스마트 팩토리 미러형 실습실[산학협동관2층I203호],,이론실습,ABCDF
스마트소프트웨어학과(심화),SW전공,1학년,전공선택,K0125329,표준프레임워크,A,4,강익태,"금[ 6, 7, 8, 9]",SW실습2실[산학협동관지상2층I204호],,이론실습,ABCDF
스마트소프트웨어학과(심화),SAP전공,1학년,전공선택,K0125567,AI캡스톤디자인,A,4,변유찬,"화[ 1, 2, 3, 4]",스마트 팩토리 미러형 실습실[산학협동관2층I203호],,실습,ABCDF
스마트소프트웨어학과(심화),SAP전공,1학년,전공선택,K0125583,Fiori심화,A,4,변유찬,"목[ 1, 2, 3, 4]",스마트 팩토리 미러형 실습실[산학협동관2층I203호],,이론실습,ABCDF
스마트소프트웨어학과(심화),SAP전공,1학년,전공선택,K0125577,S/4HANA ABAP프로그래밍,A,4,김범준,"목[ 6, 7, 8, 9]",스마트 팩토리 미러형 실습실[산학협동관2층I203호],,이론실습,ABCDF
스마트소프트웨어학과(심화),SAP전공,1학년,전공선택,K0125558,빅데이터실습,A,4,이덕기,"월[ 6, 7, 8]/수[ 1]",스마트 팩토리 미러형 실습실[산학협동관2층I203호],0,실습,ABCDF
공통학과,LG ES 배터리트랙,2학년,교양선택,K0125431,이문화이해,B,2,이상민,"화[ 2, 3]",LGES배터리/하이엠솔루텍 실습실[산학협동관1층I108호],30,이론,ABCDF
공통학과,LG ES 배터리트랙,2학년,전공선택,K0125306,리튬이차전지 생산요소기술,B,2,이남석,"목[ 2, 3]",LGES배터리/하이엠솔루텍 실습실[산학협동관1층I108호],30,이론,ABCDF
공통학과,LG ES 배터리트랙,2학년,전공선택,K0125222,리튬이차전지개론,B,2,이남석,"수[ 1, 2]",LGES배터리/하이엠솔루텍 실습실[산학협동관1층I108호],30,이론,ABCDF
공통학과,LG ES 배터리트랙,2학년,전공선택,110491,생산및품질관리,B,4,이쌍수,"수[ 4, 5, 6, 7]",LGES배터리/하이엠솔루텍 실습실[산학협동관1층I108호],30,이론,ABCDF
공통학과,반도체 트랙,2학년,전공선택,K0125429,반도체품질관리기초,A,3,김기범,"수[ 6, 7, 8]",반도체실습실[산학협동관3층I306호],30,이론,ABCDF
공통학과, LG전자 스마트파크,2학년,교양선택,K0125435,기업과경영1,E1,2,김창근,"월[ 6, 7]",LG전자스마트파크/LG전자 서비스 실습실[산학협동관1층I106호],30,이론,ABCDF
공통학과, LG전자 스마트파크,2학년,교양선택,K0125435,기업과경영1,E2,2,김창근,"월[ 2, 3]",LG전자스마트파크/LG전자 서비스 실습실[산학협동관1층I106호],30,이론,ABCDF
공통학과, LG전자 스마트파크,2학년,교양선택,K0125244,산업재해와사전예방,E1,2,이상민,"월[ 2, 3]",LGES배터리/하이엠솔루텍 실습실[산학협동관1층I108호],30,이론,ABCDF
공통학과, LG전자 스마트파크,2학년,교양선택,K0125244,산업재해와사전예방,E2,2,이상민,"월[ 6, 7]",LGES배터리/하이엠솔루텍 실습실[산학협동관1층I108호],30,이론,ABCDF
공통학과, LG전자 스마트파크,2학년,전공선택,110411,금형개론,E2,2,김문규,"수[ 6, 7]",LG전자스마트파크/LG전자 서비스 실습실[산학협동관1층I106호],30,이론,ABCDF
공통학과, LG전자 스마트파크,2학년,전공선택,K0125432,생산혁신,E,2,류용현,"화[ 6, 7]",다목적강의실[연암미래관1층101호],30,이론,ABCDF
공통학과,화공트랙,2학년,전공선택,K0125137,석유화학개론,C1,3,정선기,"화[ 1, 2, 3]",화공융합 실습실[산학협동관1층I111호],30,이론,ABCDF
공통학과,화공트랙,2학년,전공선택,K0125137,석유화학개론,C2,3,정선기,"월[ 6, 7, 8]",화공융합 실습실[산학협동관1층I111호],30,이론,ABCDF
공통학과,화공트랙,2학년,전공선택,K0125138,일반화학개론,C1,3,김둘선,"목[ 1, 2, 3]",화공융합 실습실[산학협동관1층I111호],30,이론,ABCDF
공통학과,화공트랙,2학년,전공선택,K0125138,일반화학개론,C2,3,김둘선,"수[ 6, 7, 8]",화공융합 실습실[산학협동관1층I111호],30,이론,ABCDF


                            사용자의 질문에 맞게 강의 목록을 정리해서 자연스럽고 존댓말로 답변해줘.
                            테이블에 모든 데이터를 꼼꼼히 읽어서 있는 내용들로만 답해줘. 너가 창작하지마! 강좌를 물어보면 어느과를 원하는지 부터 물어보고 과를 알려주면 그 과에 대한 강좌만 말해줘 그리고 또 다른 강좌가 있냐고 물어보면 답변했던 강좌는 제외하고 답변해줘
                            규칙 잘 지키면 쿠키 줄게
                            """

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": question}
        ]

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages
        )
        print(response.choices[0].message.content)
        return response.choices[0].message.content

    except Exception as e:
        return f"[GPT 또는 CSV 처리 오류] {str(e)}"







# def load_lecture_chunks():
#     base_path = os.path.dirname(__file__)  # 현재 파이썬 파일 기준
#     file_path = os.path.join(base_path, "lectures.csv")
#     chunks = []
#     with open(file_path, encoding="utf-8-sig") as f:
#         reader = csv.DictReader(f)
#         for row in reader:
#             chunk = f"{row['학과']} {row['학년']} {row['이수구분']} 과목 중 하나는 '{row['교과목명']}'(코드: {row['코드']})이며, 담당 교수는 {row['교수']}입니다. 수업은 {row['강의시간표']}에 열리며, 강의실은 {row['강의실']}입니다. 학점은 {row['학점']}학점입니다."
#             chunks.append(chunk)
#     return chunks
#
# # 장소 키워드 필터링
# def filter_chunks_by_place(chunks, keywords):
#     return [chunk for chunk in chunks if any(k in chunk for k in keywords)]
#
# # 대화 처리
# def answer_from_gpt(user_messages, lecture_chunks):
#     place_keywords = ["산학협동관", "미래관", "강의동", "특별강의동", "연암"]
#     filtered = filter_chunks_by_place(lecture_chunks, place_keywords)
#     print("filtered",filtered)
#     system_context = "\n".join(filtered[:5])
#     messages = [
#         {"role": "system", "content": f"너는 연암공과대학교의 수업 안내 AI야. 아래 문서를 참고해서 사용자 질문에 답해줘. 문서에 없는 내용은 '해당 정보는 확인되지 않았습니다'라고 정중히 말해:\n\n{system_context}"}
#     ] + user_messages
#     print(system_context)
#     response = client.chat.completions.create(
#         model="gpt-4o",
#         messages=messages,
#         temperature=0.2,
#         max_tokens=512
#     )
#
#     return response.choices[0].message.content